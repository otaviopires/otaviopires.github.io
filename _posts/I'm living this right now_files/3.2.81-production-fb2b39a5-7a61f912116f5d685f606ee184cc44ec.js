!function(e){e.oauthpopup=function(t){if(!t||!t.path)throw new Error("options.path must not be empty");t=e.extend({windowName:"ConnectWithOAuth",windowOptions:"location=0,status=0,width=800,height=400",callback:function(){window.location.reload()}},t);var n=window.open(t.path,t.windowName,t.windowOptions),r=window.setInterval(function(){return n?(n.closed&&(window.clearInterval(r),t.callback()),void 0):(window.clearInterval(r),console&&console.error("Please make sure your browser is allowing popups for this domain"),t.callback(!1))},1e3)}}(jQuery),function(e){function t(e,t){return"function"==typeof e?e.call(t):e}function n(t,n){this.$element=e(t),this.options=n,this.enabled=!0,this.fixTitle()}n.prototype={show:function(){var n=this.getTitle();if(n&&this.enabled){var r=this.tip();r.find(".tipsy-inner")[this.options.html?"html":"text"](n),r[0].className="tipsy",r.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body);var i,s=e.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight}),a=r[0].offsetWidth,o=r[0].offsetHeight,u=t(this.options.gravity,this.$element[0]);switch(u.charAt(0)){case"n":i={top:s.top+s.height+this.options.offset,left:s.left+s.width/2-a/2};break;case"s":i={top:s.top-o-this.options.offset,left:s.left+s.width/2-a/2};break;case"e":i={top:s.top+s.height/2-o/2,left:s.left-a-this.options.offset};break;case"w":i={top:s.top+s.height/2-o/2,left:s.left+s.width+this.options.offset}}2==u.length&&(i.left="w"==u.charAt(1)?s.left+s.width/2-15:s.left+s.width/2-a+15),r.css(i).addClass("tipsy-"+u),r.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+u.charAt(0),this.options.className&&r.addClass(t(this.options.className,this.$element[0])),this.options.fade?r.stop().css({opacity:0,display:"block",visibility:"visible"}).animate({opacity:this.options.opacity}):r.css({visibility:"visible",opacity:this.options.opacity})}},hide:function(){this.options.fade?this.tip().stop().fadeOut(function(){e(this).remove()}):this.tip().remove()},fixTitle:function(){var e=this.$element;(e.attr("title")||"string"!=typeof e.attr("original-title"))&&e.attr("original-title",e.attr("title")||"").removeAttr("title")},getTitle:function(){var e,t=this.$element,n=this.options;this.fixTitle();var e,n=this.options;return"string"==typeof n.title?e=t.attr("title"==n.title?"original-title":n.title):"function"==typeof n.title&&(e=n.title.call(t[0])),e=(""+e).replace(/(^\s*|\s*$)/,""),e||n.fallback},tip:function(){return this.$tip||(this.$tip=e('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>')),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},e.fn.tipsy=function(t){function r(r){var i=e.data(r,"tipsy");return i||(i=new n(r,e.fn.tipsy.elementOptions(r,t)),e.data(r,"tipsy",i)),i}function i(){var e=r(this);e.hoverState="in",0==t.delayIn?e.show():(e.fixTitle(),setTimeout(function(){"in"==e.hoverState&&e.show()},t.delayIn))}function s(){var e=r(this);e.hoverState="out",0==t.delayOut?e.hide():setTimeout(function(){"out"==e.hoverState&&e.hide()},t.delayOut)}if(t===!0)return this.data("tipsy");if("string"==typeof t){var a=this.data("tipsy");return a&&a[t](),this}if(t=e.extend({},e.fn.tipsy.defaults,t),t.live||this.each(function(){r(this)}),"manual"!=t.trigger){var o=t.live?"live":"bind",u="hover"==t.trigger?"mouseenter":"focus",l="hover"==t.trigger?"mouseleave":"blur";this[o](u,i)[o](l,s)}return this},e.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover"},e.fn.tipsy.elementOptions=function(t,n){return e.metadata?e.extend({},n,e(t).metadata()):n},e.fn.tipsy.autoNS=function(){return e(this).offset().top>e(document).scrollTop()+e(window).height()/2?"s":"n"},e.fn.tipsy.autoWE=function(){return e(this).offset().left>e(document).scrollLeft()+e(window).width()/2?"e":"w"},e.fn.tipsy.autoBounds=function(t,n){return function(){var r={ns:n[0],ew:n.length>1?n[1]:!1},i=e(document).scrollTop()+t,s=e(document).scrollLeft()+t,a=e(this);return a.offset().top<i&&(r.ns="n"),a.offset().left<s&&(r.ew="w"),e(window).width()+e(document).scrollLeft()-a.offset().left<t&&(r.ew="e"),e(window).height()+e(document).scrollTop()-a.offset().top<t&&(r.ns="s"),r.ns+(r.ew?r.ew:"")}}}(jQuery),s.Button=s.Class.extend({initialize:function(e,t){return this.options={toggle:!1,activeClass:"active"},this.setOptions(t),this.button=$(e),this.options.title&&this.button.attr("title",this.options.title),this.button.bind("mousedown.button",_.bind(this.mousedown,this)),this.button.bind("click.button",_.bind(this.click,this)),this},mousedown:function(e){return this.options.mousedown&&this.options.mousedown(e),this},click:function(e){return e.preventDefault(),this.disabled?!1:(this.options.click&&this.options.click(e),this.options.toggle&&this.toggle(e),this)},activate:function(e){return this.options.activate&&!this.options.activate(e)?!1:(this.button.addClass(this.options.activeClass),this)},deactivate:function(e){return this.options.deactivate&&!this.options.deactivate(e)?!1:(this.button.removeClass(this.options.activeClass),this)},enable:function(){return this.disabled=!1,this.button.removeAttr("disabled"),this},disable:function(){return this.disabled=!0,this.button.attr("disabled","disabled"),this},hide:function(){return this.button.hide(),this},show:function(){return this.button.show(),this},toggle:function(e){return this.active()?this.deactivate(e):this.activate(e),this},active:function(){return this.button.hasClass(this.options.activeClass)}}),s.Dropdown=s.Button.extend({initialize:function(e,t,n){n=n||{},n.toggle=!0,this.supr(e,n),this.menu=$(t),this._menu=t},setPosition:function(){var e=this.options.gap?this.options.gap:0;return this.menu.css({top:this.button.position().top+this.button.outerHeight()+e,minWidth:this.button.innerWidth()+"px"}),this.options.right&&this.menu.css({right:this.options.right}),this},activate:function(e){var t=this;return e&&e.stopPropagation(),this.supr(e)?(this.menu.addClass(this.options.activeClass).show(),$(this.button).trigger("click.dropdown"),_.defer(function(){$(window).bind("click.dropdown keyup.dropdown",_.bind(t.deactivate,t))}),this):!1},deactivate:function(e){if(e){if(this.options.exceptionId&&$(e.target).attr("id")===this.options.exceptionId)return;if(!(e.currentTarget==this.button[0]||e.keyCode&&27==e.keyCode||0==this.menu.find(e.target).length||this.options.isList&&this.menu.find($(e.target).parent()).length>0))return;$(window).unbind(e)}else $(window).unbind();return this.supr(e)?(this.menu.removeClass(this.options.activeClass).hide(),this):!1},hide:function(){return this.menu.hide(),this.button.hide(),this},show:function(){return this.button.show(),this.setPosition(),this}}),s.Modal=s.Class.extend({overlayId:"#page-overlay",initialize:function(e,t){this.options={closeable:!0},this.setOptions(t),this.modal=$(e),this.overlay=$(this.overlayId),this.overlay.length||(this.overlay=$("<div>").attr("id",this.overlayId),$("body").append(this.overlay)),$("body").append(this.modal),_.bindAll(this,"hide"),this.options.closeable&&(this.closeBtn=this.modal.find(".close-x, .close, .skip"),this.closeBtn.live("click touchend",this.hide))},hide:function(e){if(e){if("keydown"==e.type){if(27!=e.keyCode)return;$(window).unbind("keydown.modal")}e.preventDefault()}return this.overlay.hide(),this.modal.hide(),this.options.hide&&this.options.hide(),this},show:function(){return this.overlay.show(),this.modal.show(),this.options.closeable&&(this.overlay.one("click",this.hide),$(window).bind("keydown.modal",this.hide)),this.options.show&&this.options.show(),this},visible:function(){return"none"!=this.modal.css("display")}}),s.Notify=s.Class.extend({initialize:function(){},clear:function(e){("string"==typeof e||"element"==typeof e)&&(e=$(e)),e.find(".flash").remove()},create:function(e,t){if(t.element){("string"==typeof t.element||"element"==typeof t.element)&&(t.element=$(t.element)),this.clear(t.element);var n=$(s.templates.render("layout/_flash",{message:e,type:t.type}));t.element.prepend(n),t.width&&n.width(t.width).addClass("borders"),t.slideSpeed=t.slideSpeed||200,_.defer(function(){n.slideDown(t.slideSpeed),t.duration&&_.delay(function(){n.slideUp(t.slideSpeed)},t.duration)})}},error:function(e,t){this.create(e,_.extend(t||{},{type:"error"}))},success:function(e,t){this.create(e,_.extend(t||{},{type:"success"}))},warning:function(e,t){this.create(e,_.extend(t||{},{type:"warning"}))},form:{removeError:function(e){$(e.currentTarget).removeClass("error").next(".error").remove()},clearValidationError:function(e){e.find("input").removeClass("error"),e.parent().find(".error, .success").remove()},validationError:function(e,t){var n=this;n.clearValidationError(t),_.isUndefined(e.fields)||(_.each(e.fields,function(e,r){t.find("input[name="+r+"]").unbind("keypress").one("keypress",_.bind(n.removeError,n)).addClass("error").after('<div class="error under">'+e+"</div>")}),t.find("input.error:first").select(),e.message="Fix any errors with the fields below."),s.notify.error(e.message,{element:t.parent()})}}}),$(function(){s.notify=new s.Notify}),s.Auth=s.Class.extend({initialize:function(e){this.setOptions(e),$(".login-main").show(),this.el={login:$("#login form"),loginButtons:$("#login .buttons"),loginUsername:$("#login-username"),loginPassword:$("#login-password"),loginStay:$("#login-stay"),loginSubmit:$("#login-submit"),signup:$("#signup form"),follow_storify:$("#follow-storify-container"),signupUsername:$("#signup-username"),signupEmail:$("#signup-email"),signupPassword:$("#signup-password"),signupSubmit:$("#signup-submit"),forgot:$("#recover form"),forgotEmail:$("#forgot-password-email"),forgotSubmit:$("#forgot-password-submit"),reset:$("#reset form"),usersList:$("#friends #users"),header:$("#friends .header"),filterLink:$("#friends .filter a"),follow:$("#friends #users .user button"),followAll:$("#subscribe-to-all"),showLogin:$("#login .showForm"),logout:$("#logout"),captchaSubmit:$("#captcha-submit")},this.next=s.utils.getUrlParams("next")||"/",this.popup="true"==s.utils.getUrlParams("popup"),this.next.match(/^(http|\/\/)/)&&!this.next.match(/https?:\/\/.*\.?storify\.com/i)&&(this.next="/"),this.cookieName="user","production"!==s.env&&(this.cookieName=s.env+"-"+this.cookieName);var t=s.store.get("user"),n=s.cookie.get(this.cookieName);if(null!=n)if(t&&t.username===n.username)this.setUser(t);else if(n._id)this.setUser(n),this.setUserCookie();else if(""==n)s.cookie.remove(this.cookieName),s.cookie.remove(this.cookieName,".storify.com");else{var r=this;$.getJSON("/currentUser",function(e){!e||e.error?(s.cookie.remove(r.cookieName),s.cookie.remove(r.cookieName,".storify.com")):(s.store.set("user",e),window.location.reload())})}else t&&s.store.remove("user");if(this.el.signup.length&&(s.everyauth.twitter||s.everyauth.facebook)&&this.showSignup(this.loginCallback),$("input").length>0&&$("input").first().focus(),$("#friends").length>0){var i=s.utils.getUrlParams("service")||"facebook";$("a.tab[rel="+i+"]").addClass("active"),$(".skip").attr("href",decodeURIComponent(this.next)),this.displayFriends(i)}this.addNextParam(),this.bind()},bind:function(){var e=this;_.bindAll(this,"login","logout","signupSubmit","signup","forgotPassword","resetPassword","getIdentity","displayFriends","filterLinkClicked","followHoverIn","followHoverOut","followClick","followAll","showLoginForm","submitCaptcha"),this.captchaModal=s.Modal?new s.Modal("#recaptcha",{closeable:!1}):{},this.el.login.bind("submit",this.login),this.el.signup.bind("submit",this.signupSubmit),this.el.forgot.bind("submit",this.forgotPassword),this.el.reset.bind("submit",this.resetPassword),$("#storify-auth .button.twitter").bind("click",function(t){t.preventDefault(),e.serviceAuth("twitter",{height:635})}),$("#storify-auth .button.facebook").bind("click",function(t){t.preventDefault(),e.serviceAuth("facebook")}),this.el.filterLink.bind("click",this.filterLinkClicked),this.el.follow.live("mouseenter",this.followHoverIn),this.el.follow.live("mouseleave",this.followHoverOut),this.el.follow.live("click",this.followClick),this.el.followAll.live("click",this.followAll),this.el.showLogin.click(this.showLoginForm),this.el.logout.click(this.logout),this.el.captchaSubmit.click(this.submitCaptcha)},showLoginForm:function(e){e.preventDefault(),this.el.showLogin.hide(),this.el.login.slideDown()},follow:function(e,t,n){var r=this,i="undefined"==typeof n?"add":n?"remove":"add";if(!r.user)return t(new Error("Not authenticated"));var a="/users/"+r.user.username+"/subscriptions/"+i;s.api.request("POST",a,{user:e,username:r.user.username,_token:r.user._token},{},function(e,n){return e?t(e.error.message):(t(null,n),void 0)})},unfollow:function(e,t){this.follow(e,t,!0)},getIdentity:function(e,n){if(!this.user||!e)return n(null);if(this.user.identities){var r=this.user.identities[e];if(n&&r)return n(r)}var i=this,a="/users/"+i.user.username+"/identities";s.api.request("GET",a,{username:i.user.username,_token:i.user._token},{},function(r,a){if(r)return s.notify.error(t(r.error.message),{element:"#content",slideSpeed:200,duration:15e3});var o=a.content;i.user.identities=i.user.identities||{};for(var u in o){var l=o[u];i.user.identities[l.service]=l}n(i.user.identities[e])})},serviceSignup:function(e){this.el.signupUsername.val(this.serviceData(e).username),this.showSignup(this.loginCallback)},serviceAuth:function(e,n){var r=this;n=$.extend({login:!0,popup:!0,width:800,height:400},n);var i=screen.width/2-n.width/2,a=screen.height/2-n.height/2,o="/auth/"+e+"?"+$.param(n);$.oauthpopup({path:o,windowOptions:"location=0,status=0,width="+n.width+",height="+n.height+",left="+i+",top="+a,callback:function(){s.everyauth=s.ea&&s.utils.parseJSON(s.ea)||{},s.everyauth[e]&&s.everyauth[e].accessToken?r.serviceLogin(e):r.validationError({message:t("Log in to __service__ denied",{service:e})},r.el.login)}})},showCaptcha:function(e){"function"==typeof e&&(this.captchaSubmitCallback=e),Recaptcha.reload(),this.el.captchaSubmit.removeAttr("disabled"),this.captchaModal.show(),$("#recaptcha input[name=recaptcha_response_field]").focus()},submitCaptcha:function(e){e.preventDefault();var n=$("#recaptcha input[name=recaptcha_challenge_field]"),r=$("#recaptcha input[name=recaptcha_response_field]");return r.val()?"function"!=typeof this.captchaSubmitCallback?(s.notify.error(t("Something weird happened. Please reload and try again."),{element:$("#recaptcha"),duration:4e3}),void 0):(this.el.captchaSubmit.attr("disabled",!0),this.captchaSubmitCallback({challenge:n.val(),response:r.val()}),void 0):(s.notify.error(t("Please fill in the captcha"),{element:$("#recaptcha"),duration:4e3}),void 0)},serviceData:function(e,t){var n=s.everyauth[e];return n&&"undefined"!=typeof n||(s.raven&&s.raven.started&&s.raven.Raven.captureMessage("auth.js:263. auth not defined? Service: "+JSON.stringify(e)+". s.everyauth: "+JSON.stringify(s.everyauth)+". s.ea : "+JSON.stringify(s.ea)),s.everyauth=s.ea&&s.utils.parseJSON(s.ea)||{},n=s.everyauth[e],n&&"undefined"!=typeof n)?{token:n.accessToken,secret:n.accessTokenSecret,service:e,service_userid:n.user.id,username:n.user.screen_name||n.user.username||n.user.id||n.user.email||(n.user.firstName?n.user.firstName+" "+n.user.lastName:void 0),name:n.user.name||n.user.full_name||(n.user.firstName?n.user.firstName+" "+n.user.lastName:void 0),email:n.user.email,avatar:n.user.profile_picture||n.user.photo,bio:n.user.description||n.user.bio,location:"object"==typeof n.user.location?n.user.location.name:n.user.location,website:n.user.url||(n.user.website?n.user.website.split("\n")[0]:void 0),captcha:t&&JSON.stringify(t)}:(s.raven&&s.raven.started&&s.raven.Raven.captureMessage("auth.js:269. auth still not defined? Service: "+JSON.stringify(e)+". s.everyauth: "+JSON.stringify(s.everyauth)),{})},serviceLogin:function(e,t,n){var r=this,i=this.el.loginStay.attr("checked"),n=n||function(){};if(s.everyauth[e]&&s.everyauth[e].accessToken){var a="/auth/"+e;s.api.request("POST",a,r.serviceData(e,t),{},function(t,a){if(t)t.error&&"no_identity"==t.error.type?r.el.signup.length>0?r.serviceSignup(e):window.location.href=s.base_url+"/signup?next="+r.next:(r.validationError(t.error,r.el.login),r.logout()),n(t.error);else{r.clearValidationError(r.el.login);var o=a.content;r.setUser(o),r.setUserCookie(i),r.el.loginUsername.val(""),r.el.loginPassword.val(""),r.el.loginSubmit.removeAttr("disabled"),r.popup&&window.opener?r.close():window.location.href=decodeURIComponent(r.next),n()}})}else this.serviceAuth(e)},serviceConnect:function(e,t){var n=this;analytics.track("registration",{event:"auth-serviceConnect",service:e}),$.oauthpopup({path:"/auth/"+e,callback:function(){return s.everyauth=s.utils.parseJSON(s.ea),n.addIdentity(e,t)}})},serviceReconnect:function(e,t){var n=this;$.oauthpopup({path:"/auth/"+e,callback:function(){s.everyauth=s.utils.parseJSON(s.ea),s.everyauth[e]&&s.everyauth[e].accessToken?t(s.everyauth[e]):n.validationError({message:"Log in to "+e+" denied."},n.el.login)}})},serviceDisconnect:function(e,t){this.removeIdentity(e,t)},addIdentity:function(e,n,r){var i=this;"function"!=typeof n||r||(r=n,n=null);var a=this.serviceData(e);n&&(a.options=JSON.stringify(n)),a._token=this.user._token;var o="/users/"+s.auth.user.username+"/identities/add";s.api.request("POST",o,a,{},function(n,a){if(n){var o=n.error;if("duplicate_identity"==o.type&&o.message){msg=o.message;var u=s.utils.lastWord(msg);if("user"!==u){var l='<a href="'+s.base_url+"/"+u+' " target="_blank"> '+u+" </a>";msg=msg.replace(u,l)}}else msg="Failed to connect "+e+" account.";return s.notify.error(t(msg),{element:"#content",slideSpeed:200,duration:15e3})}i.user.identities=i.user.identities||{},i.user.identities[e]=a.content.identity,r&&r(a)})},removeIdentity:function(e,n){var r="/users/"+s.auth.user.username+"/identities/remove";s.api.request("POST",r,{identity:JSON.stringify({service:e})},{},function(r,i){r?n(r):(s.notify.success(t("Successfully unlinked __service__ account",{service:e}),{element:"#content",slideSpeed:200,duration:3e3}),n(i))})},showSignup:function(){var e=this;e.el.signup.parent().find(".buttons, .or").show(),s.everyauth.twitter&&s.everyauth.twitter.user?(e.el.signup.parent().find(".buttons, .or").hide(),e.el.signup.find(".twitter-user").remove(),e.el.signup.prepend(s.templates.render("everyauth/_twitter_user",{user:s.everyauth.twitter.user})),e.el.signupUsername.val(s.everyauth.twitter.user.screen_name),e.el.follow_storify.removeClass("hidden"),e.el.signupEmail.focus()):s.everyauth.facebook&&s.everyauth.facebook.user&&(e.el.signup.parent().find(".buttons, .or").hide(),e.el.signup.find(".facebook-user").remove(),e.el.signup.prepend(s.templates.render("everyauth/_facebook_user",{user:s.everyauth.facebook.user})),e.el.signupUsername.val(s.everyauth.facebook.user.username),e.el.signupEmail.val(s.everyauth.facebook.user.email),s.everyauth.facebook.user.username?e.el.signupPassword.focus():e.el.signupUsername.focus()),setTimeout(function(){s.notify.success(t("Your Storify account is almost ready!"),{element:e.el.signup.parent(),duration:4e3})},1e3)},showLogin:function(e){this.loginCallback=e},loginPopup:function(e){var t=this,n=400,r=480,i=screen.width/2-n/2,a=screen.height/2-r/2;$.oauthpopup({windowName:"Login",windowOptions:"location=0,status=0,width="+n+",height="+r+",top="+a+",left="+i,path:"/login?popup=true",callback:function(n){return n?e(n):($.getJSON("/currentUser",function(r){return r.error?e(r.error):(t.setUser(r),s.nav&&s.nav.updateUser(),e(n,r),void 0)}),void 0)}})},signupSubmit:function(e){e.preventDefault();for(var n=$("#signup form:first").find("input"),r=0;r<n.length;r++){var i=$(n[r]);if(!i.val()&&"checkbox"!==i.attr("type"))return i.focus(),this.validationError({message:t("Please enter the")+" "+i.attr("name")+" "+t("field")},this.el.signup),void 0}var s=this.el.signup.find("input[name=agree]");return s.attr("checked")?(this.showCaptcha(this.signup),void 0):(s.focus(),this.validationError({message:t("Please agree to the terms of service")},this.el.signup),void 0)},signup:function(e){var t,n=this,r=(this.el.signup.find("input[name=agree]").attr("checked"),this.el.signup.find("input[name=username]").val()),i=this.el.signup.find("input[name=email]").val(),a=this.el.signup.find("input[name=password]").val(),o={username:r,email:i,password:a};if(s.everyauth.twitter&&s.everyauth.twitter.user)t="twitter",o=_.extend(o,{bio:s.everyauth.twitter.user.description,avatar:s.everyauth.twitter.user.profile_image_url.replace("_normal","_reasonably_small"),website:s.everyauth.twitter.user.url,name:s.everyauth.twitter.user.name,location:s.everyauth.twitter.user.location,service:"twitter"});else if(s.everyauth.facebook&&s.everyauth.facebook.user){t="facebook",o=_.extend(o,{bio:s.everyauth.facebook.user.bio,avatar:"http://graph.facebook.com/"+(s.everyauth.facebook.user.username||s.everyauth.facebook.user.id)+"/picture",name:s.everyauth.facebook.user.name,service:"facebook"});var u=s.everyauth.facebook.user.location,l=s.everyauth.facebook.user.website;u&&(o.location=u.name),l&&(o.website=l.split("\n")[0])}this.setRaven(),n.el.signupSubmit.attr("disabled",!0);var c="/users/create";s.api.request("POST",c,{user:JSON.stringify(o),captcha:JSON.stringify(e)},{retryLimit:3},function(e,r){function i(){window.location.href=s.base_url+"/friends?service="+t+"&next="+decodeURIComponent(n.next)}if(e)n.validationError(e.error,n.el.signup),n.el.signupSubmit.removeAttr("disabled"),n.el.captchaSubmit.removeAttr("disabled"),e.error&&"captcha_failed"!=e.error.type?n.captchaModal.hide():n.showCaptcha();else{n.clearValidationError(n.el.signup);var a=r.content;n.setUser(a),n.setUserCookie(!0),n.el.signupSubmit.removeAttr("disabled"),t?"twitter"==t?n.addIdentity("twitter",{follow_storify:"checked"==n.el.follow_storify.find("#follow-storify").attr("checked")},i):"facebook"==t&&n.addIdentity("facebook",i):window.location.href=decodeURIComponent(n.next)}})},forgotPassword:function(e){e.preventDefault();var n=this,r=this.el.forgot.find("#forgot-password-email").val();this.el.forgot.find("input, button").attr("disabled",!0);var i="/auth/forgot_password",a={email:r};s.api.request("POST",i,a,{},function(e){e?(n.validationError(e.error,n.el.forgot.find("form")),n.el.forgot.find("input, button").removeAttr("disabled")):(n.clearValidationError(n.el.forgot),n.el.forgotEmail.val(""),n.el.forgotSubmit.removeAttr("disabled"),s.notify.success(t("You should receive an email shortly"),{element:$("body")}))})},resetPassword:function(e){e.preventDefault();var n=this,r=this.el.reset.find("#reset-password-password").val(),i=s.utils.getQueryString(window.location.search.substr(1).split("&"));this.el.reset.find("input, button").attr("disabled",!0);var a="/auth/reset_password",o={password:r,email:i.email,reset_token:i.reset_token};s.api.request("POST",a,o,{},function(e){e?(n.validationError(e.error,n.el.reset),n.el.reset.find("input, button").removeAttr("disabled")):(n.clearValidationError(n.el.reset),s.notify.success(t("Your password has been reset")+".",{element:$("body")}),setTimeout(function(){window.location.href=s.base_url+"/"},1e3))})},login:function(e){e.preventDefault();var t=this,n=this.el.loginUsername.val(),r=this.el.loginPassword.val(),i=this.el.loginStay.attr("checked");this.setRaven(),this.el.loginSubmit.attr("disabled",!0);var a="/auth",o={username:n,password:r};s.api.request("POST",a,o,{retryLimit:3},function(e,n){if(e)t.validationError(e.error,t.el.login),t.el.loginSubmit.removeAttr("disabled");else{t.clearValidationError(t.el.login);var r=n.content;t.setUser(r),t.setUserCookie(i),t.el.loginUsername.val(""),t.el.loginPassword.val(""),t.el.loginSubmit.removeAttr("disabled"),t.popup&&window.opener?t.close():window.location.href=decodeURIComponent(t.next)}})},close:function(){window.opener.s||(window.opener.s={}),window.opener.s.ea=JSON.stringify(s.everyauth),window.opener.s.embedUser=JSON.stringify(this.user),window.close()},setUser:function(e){this.user=e;var t={username:e.username,email:e.email,created:e.date?e.date.created:null,bio:e.bio,lang:e.lang,location:e.location,firstname:e.name,plan:e.paid_plan};e._stripe&&(e._stripe.next_recurring_charge&&(t.next_billing=e._stripe.next_recurring_charge.date,t.amount=e._stripe.next_recurring_charge.amount),t.canceled=e._stripe.dates.cancelled_at,t.plan_id=e._stripe.plan.id,t.period=e._stripe.plan.interval),this.setRaven(e),analytics.identify(e._id,t)},setRaven:function(e){s.raven?s.raven.start&&s.raven.start():s.raven={},s.raven&&s.raven.started&&e&&s.raven.Raven.setUser({username:e.username,id:e._id,plan:e.paid_plan,email:e.email})},setIntercom:function(){return!1},setUserCookie:function(e){var t={username:this.user.username,_token:this.user._token,reloadSession:!0},n={domain:".storify.com",secure:"development"!==s.env};if("development"!=s.env&&(n.secure=!0),e){var r=new Date;r.setTime(r.getTime()+2592e6),n.expires=r}s.cookie.set(this.cookieName,t,n),s.store.set("user",this.user),$.i18n&&$.i18n.setLng(this.user.lang),this.loginCallback&&this.loginCallback(),this.loginCallback=null},logout:function(){this.user=null,s.everyauth={},s.cookie.remove(this.cookieName),s.cookie.remove(this.cookieName,".storify.com"),s.store.remove("user"),s.raven.stop()},removeError:function(e){$(e.currentTarget).removeClass("error").next(".error").remove()},clearValidationError:function(e){e.find("input").removeClass("error"),e.parent().find(".error, .success").remove()},validationError:function(e,n){var r=this;return this.clearValidationError(n),e?(_.isUndefined(e.fields)||(_.each(e.fields,function(e,t){n.find("input[name="+t+"]").unbind("keypress").one("keypress",_.bind(r.removeError,r)).addClass("error").after('<div class="error under">'+e+"</div>")}),n.find("input.error:first").select(),e.message="Fix any errors with the fields below"),s.notify.error(t(e.message),{element:$("body"),duration:4e3}),void 0):s.notify.error(t("Something wrong happened, please try again."),{element:$("body"),duration:4e3})},addNextParam:function(){var e=this;$("a.next").each(function(t,n){var r=$(n).attr("href");$(n).attr("href",r+"?next="+e.next)})},displayFriends:function(e){var n={},r=this;if(!e||"undefined"==typeof e)return s.raven&&s.raven.started&&s.raven.Raven.captureMessage("auth.js:819. No service? : "+JSON.stringify(e)),void 0;r.el.usersList.empty(),r.el.usersList.append('<div class="loading"></div>'),r.el.header.hide(),r.user&&(n.username=r.user.username,n._token=r.user._token);var i="/users/"+n.username+"/friends/"+e;s.api.request("GET",i,n,{},function(n,i){if(n){var a=e.charAt(0).toUpperCase()+e.slice(1);r.el.usersList.find(".loading").remove(),r.el.usersList.append('<p class="empty">'+t("Your account is not connected to ")+a+".</p>")}else{r.el.usersList.find(".loading").remove();var o=i.content.friends;if(o&&o.length>0)for(var u=0;u<o.length;u++){var l=s.templates.render("user/_user",{s_user:o[u],s_auth_user:r.user});r.el.usersList.append(l),r.el.header.show()}else r.el.usersList.append('<p class="empty">'+t("Couldn't find any of your friends on Storify.")+"</p>")}})},filterLinkClicked:function(e){e.preventDefault();var t=$(e.target),n=t.attr("rel");this.el.filterLink.removeClass("active"),t.addClass("active"),this.displayFriends(n)},followHoverIn:function(e){var n=$(e.target).parents(".user").find("button");n.hasClass("cancel")&&n.removeClass("cancel").addClass("decline").html("<span>✖ "+t("Unsubscribe")+"</span>")},followHoverOut:function(e){var n=$(e.target).parents(".user").find("button");n.hasClass("decline")&&n.removeClass("decline").addClass("cancel").html("<span>✔ "+t("Subscribed")+"</span>")},followClick:function(e){var n=$(e.target).parents(".user").find("button"),r=n.parents(".user").attr("data-username");n.attr("disabled",!0),n.hasClass("accept")?(n.html("<span>"+t("Subscribing")+"</span>"),s.auth.follow(r,function(e){return n.removeAttr("disabled").html("<span>✚ "+t("Subscribe")+"</span>"),e?(s.notify.error(t("Unable to subscribe to __name__ at this time, please try again later",{name:r}),{element:"body",duration:4e3}),void 0):(n.removeClass("accept").addClass("cancel").html("<span>✔ "+t("Subscribed")+"</span>"),void 0)})):(n.html("<span>"+t("Unsubscribing")+"</span>"),s.auth.unfollow(r,function(e){return n.removeAttr("disabled").html("<span>✔ "+t("Subscribed")+"</span>"),e?(s.notify.error(t("Unable to unsubscribe from __name__ at this time, please try again later",{name:r}),{element:"body",duration:4e3}),void 0):(n.removeClass("cancel decline").addClass("accept").html("<span>✚ "+t("Subscribe")+"</span>"),void 0)}))},followAll:function(){this.el.usersList.find("button.accept").each(function(e,t){t.click()})}}),$(function(){s.auth=new s.Auth}),s.Embed=s.Class.extend({initialize:function(){var e=this;$(window).bind("message",_.bind(this.onMessage,this)),this.height=0,this.isEmbed=!!window.location.href.match("/embed"),this.isHtml=!!window.location.href.match(".html");var t=window.location!=window.parent.location?document.referrer:document.location;t.href&&(t=t.href),this.isOnStorify=t.match(/storify.com/)?!0:!1,this.showedPostTooltip=!1,_.bindAll(this,"sendEmail","changeEmbedCode","loadMore","resize","elementClick","activateLike","deactivateLike","likeError","likeButtonLiked","likeButtonUnliked","bottomLinkClicked","bottomLikeClicked","subscribeButtonClicked","elementCommentSubmit","elementCommentMore","elementCommentButtonClicked","elementShareButtonClicked","elementCommentMoreText","commentPostToggle","elementShareDropdownHide","shareButtonClicked","share","pin","elementLikeButtonClicked","elementLike","elementUnlike","elementCommentRemove","commentSubmit","commentsMore","commentRemove","commentTextMore","activateComment","animateBigLike","showFocus","hideFocus","commentInputKeydown","elementStorypadAdd","embedLikeButtonClicked","embedLike","embedUnlike","linkClick"),_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");t.text(s.utils.date(n).fromNow(),!0)}),this.commentDropdown=new s.Dropdown(".s-header .s-actions a.comment","#s-comment-dropdown",{activate:this.activateComment}),this.shareDropdown=new s.Dropdown(".s-header .s-actions a.share","#s-share-dropdown"),this.embedDropdown=new s.Dropdown(".s-header .s-actions a.embed","#s-embed-dropdown"),this.embedShareDropdown=new s.Dropdown(".f-actions a.share","#share-footer-dropdown"),this.likeButton=new s.Button(".s-header .s-actions a.like",{toggle:!0,activate:this.activateLike,deactivate:this.deactivateLike,activeClass:"active"}),this.embedLikeButton=new s.Button(".f-actions a.like",{toggle:!0,activate:this.activateLike,deactivate:this.deactivateLike,activeClass:"active"}),this.el={body:$("body"),storyContainer:$("#story"),story:$(".s-story"),emailSend:$("#s-email-send"),emailFrom:$("#s-email-from"),emailTo:$("#s-email-to"),emailResultSuccess:$(".s-email-result .success"),emailResultError:$(".s-email-result .error"),embedCode:$("#s-embed-code"),embedCodeDist:$("#s-embed-code-dist"),embedCopy:$("#s-copy-code"),embedTemplate:$("#s-embed-template"),embedHeader:$("#s-show-header"),embedBorder:$("#s-show-border"),embedSharing:$("#s-show-sharing"),embedSEOContainer:$(".s-embed-seo"),embedSEO:$("#s-show-seo"),embedOptions:$(".s-embed-options input, .s-embed-options select"),embedShowOptions:$(".s-embed-show"),loadMore:$(".s-load-more"),elementsList:$(".s-elements"),element:$(".s-element"),elementQuote:$(".s-element-quote"),elementShareLabel:$(".s-element-share-label"),elementCommentInput:$(".element-comment-input"),elementCommentMore:$(".element-comment-more"),elementCommentButton:$(".s-element .buttons .comment"),elementCommentRemove:$(".comments .comment a.remove"),elementCommentMoreText:$(".comments .comment a.moreComment"),elementCommentPostButton:$(".element-comment-post i"),elementStats:$(".s-element .s-element-stats"),elementShareButton:$(".s-element .buttons a.share"),elementShareDropdown:$(".s-share-dropdown"),elementLikeButton:$(".s-element a.like"),likeButton:$(".s-header .s-actions a.like"),commentButton:$(".s-header .s-actions a.comment"),bottomLink:$(".more-on-storify"),bottomLike:$(".engage .intro .like"),bottomLiked:$(".engage .liked"),bottomComment:$(".engage .comment"),bottomActionContainer:$(".engage .action-container"),bottomCommentInput:$(".engage .story-comment-input"),subscribeButton:$(".subscribe-button"),subscribeLabel:$(".subscribe-label"),subscribedLabel:$(".subscribed-label"),shareButton:$(".s-actions-share a"),comments:$("#comments .previous ul, .engage .previous ul"),commentsMore:$("#comments .more, .engage .more"),commentsNum:$("#comments .story-comment-n, .engage .story-comment-n"),commentsInput:$("#comments input, .story-comment-input"),commentRemove:$("#comments .comment .remove, .engage .comment .remove"),commentNotSpam:$("#comments .comment .notSpam, .engage .comment .notSpam"),commentMore:$("#comments .comment .moreComment, .engage .comment .moreComment"),bigLike:$("#big-like"),commentPostButton:$(".story-comment-post i"),storyCommentInput:$(".story-comment-input"),embedLikeButton:$(".f-actions a.like"),title:$(".s-title"),description:$(".s-description"),elementsText:$(".s-text"),elementsHeaderText:$(".s-text h2"),linkText:$(".s-text a")};
var n="#ffffff";if(!this.isOnStorify&&(this.isEmbed||this.isHtml)&&s.story.author.style){var r=s.story.author.style,i=null,a=null;r&&r.typekit&&!_.isEmpty(r.typekit.fonts)&&(i=_.where(r.typekit.fonts[0].families,{name:r.fonts.body}),a=_.where(r.typekit.fonts[0].families,{name:r.fonts.title})),this.el.title.css("font-family",_.isEmpty(a)?r.fonts.title:a[0].css_stack),this.el.description.css("font-family",_.isEmpty(i)?r.fonts.body:i[0].css_stack),this.el.elementsText.css("color",r.colors.text),this.el.elementsText.css("font-family",_.isEmpty(i)?r.fonts.body:i[0].css_stack),this.el.elementsHeaderText.css("color",r.colors.text),this.el.elementsHeaderText.css("font-family",_.isEmpty(i)?r.fonts.body:i[0].css_stack),this.el.linkText.css("color",r.colors.link),n=r.colors.background,$(".s-story, .s-element-content.s-text").css("background-color",r.colors.background)}if($(".s-story .s-header-top").css("background-color",n),s.story.author.options&&s.story.author.options.ga&&s.story.author.ga_tracker&&_gaq.push(["b._setAccount",s.story.author.ga_tracker],["b._trackPageview"]),$.fn.tipsy&&(this.el.commentPostButton.tipsy({gravity:$.fn.tipsy.autoBounds(100,"s"),fade:!0,delayIn:500}),this.el.elementCommentPostButton.tipsy({gravity:$.fn.tipsy.autoBounds(100,"s"),fade:!0,delayIn:500,live:!0}),$(".s-actions a, .actions a").tipsy({gravity:$.fn.tipsy.autoBounds(100,"s"),fade:!0,delayIn:500,live:!0})),this.path=s.user.username+"/"+s.story.slug,this.per_page=25,this.page=2,this.has_feature=function(e,t){switch(e){case"liveUpdate":setTimeout(function(){return s.story.author.features_enabled.realtime_updates?t(!0):window.location.href.match("/embed")?void 0:t(!0)},1e3,t);break;case"infinite_scroll":var n=(s.story.author.settings?s.story.author.settings.options:s.story.author.options)||{};if(n.infinite_scroll)return t(!0)}},this.el.elementsList.children().length<this.per_page&&this.el.loadMore.remove(),s.auth.user?(this.el.emailFrom.val(s.auth.user.email),(s.auth.user._access>0||-1!=["ajstream","bilalr"].indexOf(s.auth.user.username))&&this.el.embedSEOContainer.show(),s.auth.getIdentity("facebook",function(e){s.auth.getIdentity("twitter",function(t){e&&s.auth.user.settings.facebook_post&&$(".story-comment-facebook, .element-comment-facebook").addClass("active"),t&&s.auth.user.settings.twitter_post&&$(".story-comment-twitter, .element-comment-twitter").addClass("active")})})):$("body").hasClass("touch")&&!this.isEmbed&&(this.el.commentButton.hide(),this.el.commentButton.siblings(".comment-count").hide(),this.el.likeButton.hide(),this.el.likeButton.siblings(".like-count").hide(),this.el.elementLikeButton.hide(),this.el.elementCommentButton.hide(),this.el.elementStats.hide(),$("#messages").append('<div class="message">Login to engage with this story</div>')),this.embedCodeTemplate='<div class="storify"><iframe src="{{base}}/{{username}}/{{slug}}/embed{{options}}" width="100%" height="750" frameborder="no" allowtransparency="true"></iframe><script src="{{base}}/{{username}}/{{slug}}.js{{options}}"></script><noscript>[<a href="{{base}}/{{username}}/{{slug}}" target="_blank">View the story "{{title}}" on Storify</a>]',this.changeEmbedCode(),this.el.emailSend.click(this.sendEmail),this.el.embedOptions.change(this.changeEmbedCode),this.el.embedCode.click(this.embedCodeClick),this.el.embedCodeDist.click(this.embedCodeClick),this.el.loadMore.click(this.loadMore),this.el.bottomLink.click(this.bottomLinkClicked),this.el.bottomLike.click(this.bottomLikeClicked),this.el.bottomComment.click(this.bottomCommentClicked),this.el.bottomCommentInput.bind("focus",function(t){e.showFocus(t)}),this.el.bottomCommentInput.bind("blur",this.hideFocus),this.el.subscribeButton.click(this.subscribeButtonClicked),this.el.elementCommentMore.live("click",this.elementCommentMore),this.el.elementCommentInput.live("keydown",this.commentInputKeydown),this.el.elementCommentInput.live("keypress",this.elementCommentSubmit),this.el.elementCommentButton.live("click",this.elementCommentButtonClicked),this.el.elementCommentRemove.live("click",this.elementCommentRemove),this.el.elementCommentMoreText.live("click",this.elementCommentMoreText),this.el.elementCommentPostButton.live("click",this.commentPostToggle),this.el.elementStats.live("click",this.elementCommentButtonClicked),this.el.elementCommentInput.live("focus",this.showFocus),this.el.elementCommentInput.live("blur",this.hideFocus),this.commentsPerPage=10,this.commentsPage=2,this.commentsNum=s.story.stats.comments-this.commentsPerPage,this.el.commentsInput.keydown(this.commentInputKeydown),this.el.commentsInput.keypress(this.commentSubmit),this.el.commentsMore.click(this.commentsMore),this.el.commentRemove.live("click",this.commentRemove),this.el.commentNotSpam.live("click",this.commentNotSpam),this.el.commentMore.live("click",this.commentTextMore),this.el.commentPostButton.live("click",this.commentPostToggle),this.el.commentsInput.bind("focus",this.showFocus),this.el.commentsInput.bind("blur",this.hideFocus),this.el.body.click(this.elementShareDropdownHide),this.el.elementShareButton.live("click",this.elementShareButtonClicked),this.el.elementLikeButton.live("click",this.elementLikeButtonClicked),this.el.shareButton.live("click",this.shareButtonClicked),$(".twitter-reply").live("click",function(){analytics.track("engagement-share",{event:"twitter-reply",context:"embed-local",source:"twitter"})}),$(".twitter-retweet").live("click",function(){analytics.track("engagement-share",{event:"twitter-retweet",context:"embed-local",source:"twitter"})}),$(".s-text a").live("click",this.linkClick),/^#[0-9a-z]{6}$/.test(window.location.hash)&&$(window).load(function(){e.linkClick(window.location.hash)}),window.location.href.match(/\/preview$/)||this.getRelatedStories(),s.story.liked&&this.likeButtonLiked(!0),this.has_feature("liveUpdate",function(){var t=(new Date).getTime()-new Date(s.story.date.published).getTime();36e5>t&&e.pollPerseids()}),e.resize(),$(window).load(function(){e.ensureResize()}),$("body").hasClass("touch")){var o;this.el.elementQuote.find(".s-element-actions").css("opacity",1),this.el.elementQuote.hammer&&this.el.elementQuote.hammer({drag:!1})&&this.el.elementQuote.hammer({drag:!1}).bind&&this.el.elementQuote.hammer({drag:!1}).bind("tap",function(e){var t=$(e.target).find(".actions");t.show(),clearTimeout(o),o=setTimeout(function(){t.hide()},5e3)})}e.render()},pollPerseids:function(){function e(){$.ajax({url:s.perseids+"/await/",data:{resource:"urn:storify:"+s.story.sid+":"+s.story.version},dataType:"json",success:function(n){if(n.timeout)return e();if("error"===n.status)return setTimeout(e,1e3);var r=s.story.version;t.reload(function(t){return t?setTimeout(e,1e3):s.story.version===r?setTimeout(e,5e3):(e(),void 0)})},error:function(){setTimeout(e,1e3)}})}var t=this;e()},renderText:function(){if(!this.isOnStorify&&(this.isEmbed||this.isHtml)&&s.story.author.style){var e=s.story.author.style,t=null,n=null;e&&e.typekit&&!_.isEmpty(e.typekit.fonts)&&(t=_.where(e.typekit.fonts[0].families,{name:e.fonts.body}),n=_.where(e.typekit.fonts[0].families,{name:e.fonts.title})),this.el.elementsText=$(".s-text"),this.el.elementsHeaderText=$(".s-text h2"),this.el.linkText=$(".s-text a"),this.el.title.css("font-family",_.isEmpty(n)?e.fonts.title:n[0].css_stack),this.el.description.css("font-family",_.isEmpty(t)?e.fonts.body:t[0].css_stack),this.el.elementsText.css("color",e.colors.text),this.el.elementsText.css("font-family",_.isEmpty(t)?e.fonts.body:t[0].css_stack),this.el.elementsHeaderText.css("color",e.colors.text),this.el.elementsHeaderText.css("font-family",_.isEmpty(t)?e.fonts.body:t[0].css_stack),this.el.linkText.css("color",e.colors.link),$(".s-story, .s-element-content.s-text").css("background-color",e.colors.background)}},renderAnchorLinks:function(){this.isOnStorify&&this.el.story.find("h1[id], h2[id]").not(":has(a.storifycon-source-link)").each(function(){$("<a>").attr("href","#"+this.id).attr("title","Click to link to this header").addClass("storifycon-source-link").tipsy({fade:!0,gravity:$.fn.tipsy.autoBounds(20,"n")}).prependTo(this)})},renderTimestampTooltips:function(){this.el.story.find(".s-text [data-timestamp]:not([original-title])").each(function(){var e=$(this),t=moment(parseInt(e.attr("data-timestamp"))),n=t.toString().match(/\((.+?)\)/),r="in your timezone";n&&(r=n[1]),n=e.text().match(/\w+$/);var i=n&&n[0];r!==i&&e.attr("title",t.format("LLL")+" "+r).tipsy({fade:!0,gravity:$.fn.tipsy.autoBounds(20,"n")})})},renderExternalIframe:function(){if(!s.story.author.features_enabled.headerless_embed){var e=s.base_url;0===e.indexOf("//")&&(e=window.location.protocol+e),this.postMessage({method:"loadExternalNavIframe",value:{storyId:s.story.sid,html:s.templates.render("story/_pinned_header",{base_url:e,isEmbed:!0,isExternalNav:!0,story:s.story})}})}},render:function(){this.renderText(),this.renderAnchorLinks(),this.renderTimestampTooltips(),this.renderExternalIframe(),s.utils.emojify(),this.ensureResize()},ensureIdentity:function(e,t,n){var r=this;s.auth.user?s.auth.getIdentity(t,function(e){e?n(!0):s.auth.serviceConnect(t,function(e){n(!!e)})}):s.auth.loginPopup(function(i,s){!i&&s&&(r.postMessage({method:"login",value:s}),r.ensureIdentity(e,t,n))})},commentInputKeydown:function(e){if(s.cookie.get("postSeen"))return!0;s.cookie.set("postSeen",!0);var t=$(e.target).parents(".action-container").find(".element-comment-post, .story-comment-post");$.fn.tipsy&&(t.tipsy({trigger:"manual",html:!0,opacity:.95,fade:!0,fallback:'Press "enter" to submit your comment.<br />You can also toggle Twitter/Facebook sharing.',gravity:$.fn.tipsy.autoBounds(144,"ne"),offset:2}),t.tipsy("show"))},commentPostUpdateSetting:function(e,n){if(s.auth.user){var r={settings:{}};r.settings[e+"_post"]=n;var i="/users/"+s.auth.user.username+"/update",a={user:JSON.stringify(r),username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",i,a,{},function(e,n){e?s.notify.error(t("Error updating the user, please try again"),{element:"#container",duration:3e3}):(s.auth.setUser(n.content),s.auth.setUserCookie(),s.nav&&s.nav.updateUser())})}},commentPostToggle:function(e){var t=this,n=$(e.currentTarget),r=n.attr("data-service");n.hasClass("active")?(n.removeClass("active"),t.commentPostUpdateSetting(r,!1)):t.ensureIdentity(e,r,function(e){e&&(n.addClass("active"),t.commentPostUpdateSetting(r,!0))})},commentSubmit:function(e){if(13==e.keyCode){e.preventDefault();var t=this,n=$(e.currentTarget),r=n.val();$.fn.tipsy&&n.parents(".action-container").find(".element-comment-post, .story-comment-post").tipsy("hide"),r&&(s.auth.user?t.comment(n,r):s.auth.loginPopup(function(e,i){!e&&i&&(t.postMessage({method:"login",value:i}),t.comment(n,r))}))}},comment:function(e,n){var r=this,i=e.parent().find(".story-comment-facebook").hasClass("active"),a=e.parent().find(".story-comment-twitter").hasClass("active");e.prop("disabled",!0);var o="/stories/"+s.user.username+"/"+s.story.slug+"/comments/add",u={username:s.auth.user.username,_token:s.auth.user._token,comment:_.trim(n),published:!0,twitter:a,facebook:i};s.api.request("POST",o,u,{},function(n,i){if(n)e.val("").prop("disabled",!1),s.notify.error(t("Error posting the comment, please try again"),{element:"#container",duration:3e3});else{var a=s.templates.render("story/elements/_comment",{comment:i.content,prune:!1});r.el.comments.prepend(a),r.updateTimestamps(),e.val("").blur(),e.prop("disabled",!1),r.el.commentButton.removeClass("no-comment");var o=r.el.commentButton.find(".comment-count"),u=parseInt(o.html())+1;o.html(u),o.removeClass("hidden"),analytics.track("engagememt",{event:"story-comment",context:"embed-local",auth:!0,permalink:s.story.permalink})}})},commentsMore:function(e){var n=this;e.preventDefault(),n.el.commentsMore.addClass("loading");var r="/stories/"+s.user.username+"/"+s.story.slug+"/comments",i={per_page:n.commentsPerPage,page:n.commentsPage,username:s.auth.user.username,_token:s.auth.user._token,published:!0};s.api.request("GET",r,i,{},function(e,r){if(e)n.el.commentsMore.remove(),s.notify.error(t("Error retrieving the comments, please try again"),{element:"#container",duration:3e3});else{var i=r.content.comments;i.forEach(function(e){n.el.comments.append(s.templates.render("story/elements/_comment",{comment:e}))}),_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");t.text(s.utils.date(n).fromNow())}),n.commentsNum-=n.commentsPerPage,n.commentsPage++,n.commentsNum<=0?n.el.commentsMore.remove():(n.el.commentsNum.text(n.commentsNum),n.el.commentsMore.removeClass("loading")),n.updateTimestamps(n.el.comments)}})},commentTextMore:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".comment"),r=n.find(".content"),i=n.find(".fullContent");t.addClass("hide"),r.addClass("hide"),i.removeClass("hide")},commentRemove:function(e){e.preventDefault();var n=this,r=$(e.currentTarget),i=r.parents(".comment"),a=i.attr("data-id");if(confirm("Are you sure?")){var o="/stories/"+s.user.username+"/"+s.story.slug+"/comments/remove",u={username:s.auth.user.username,_token:s.auth.user._token,comment:a,published:!0};s.api.request("POST",o,u,{},function(e){if(e)s.notify.error(t("Error removing the comment, please try again"),{element:"#container",duration:3e3});else{$(".comment-"+a).remove();var r=n.el.commentButton.find(".comment-count"),i=parseInt(r.html())-1;r.html(i),0==i&&(n.el.commentButton.addClass("no-comment"),r.addClass("hidden"))}})}},commentNotSpam:function(e){if(e.preventDefault(),confirm("Are you sure?")){var n=$(e.currentTarget),r=n.parents(".comment"),i=r.attr("data-id"),a="/stories/"+s.user.username+"/"+s.story.slug+"/comments/not_spam",o={username:s.auth.user.username,_token:s.auth.user._token,comment:i,published:!0};s.api.request("POST",a,o,{},function(e){e?s.notify.error(t("Error un-spamming the comment, please try again"),{element:"#container",duration:3e3}):(r.removeClass("spam"),r.find(".notSpam").remove())})}},activateComment:function(){return _.defer(function(){$("#comments .story-comment-input").focus()}),!0},elementCommentMoreText:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".comment"),r=n.find(".content"),i=n.find(".fullContent");t.addClass("hide"),r.addClass("hide"),i.removeClass("hide")},elementStorypadAdd:function(e,t){var n={permalink:t,type:e},r={utm_medium:"storyPage",utm_content:e};this.isEmbed?this.postMessage({method:"storify",value:JSON.stringify(n)}):sfy&&sfy.showModal&&(n.via=s.story.permalink,s.auth.user?sfy.showModal(n,r):s.auth.loginPopup(function(e,t){!e&&t&&sfy.showModal(n,r)}))},elementLikeButtonClicked:function(e){var t=this,n=$(e.target);if(n.parents(".s-element"),e.preventDefault(),s.auth.user)t.elementToggleLike(e);else{var r=$("body").attr("data-query")||"no-query";analytics.track("engagement",{event:"element-like",searchQuery:r,context:"embed-local",auth:!0,source:$elementInStory.attr("data-source")}),s.auth.loginPopup(function(n,r){!n&&r&&(t.postMessage({method:"login",value:r}),t.elementToggleLike(e))})}},elementToggleLike:function(e){var t=$(e.currentTarget);t.hasClass("active")?this.elementUnlike(t):this.elementLike(t)},elementLike:function(e){var n=this,r=e.parents(".s-element").attr("data-eid"),i=$(".s-element[data-eid="+r+"]"),a=i.find(".stats-likes");n.isEmbed||n.animateBigLike();var o="/elements/"+r+"/like",u={username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid};s.api.request("POST",o,u,{},function(r){r?s.notify.error(t("Error liking the element, please try again"),{element:"#container",duration:3e3}):(e.addClass("active"),n.incrementStat(a))})},elementUnlike:function(e){var n=this,r=e.parents(".s-element").attr("data-eid"),i=$(".s-element[data-eid="+r+"]"),a=i.find(".stats-likes"),o="/elements/"+r+"/unlike",u={username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid};s.api.request("POST",o,u,{},function(r){r?s.notify.error(t("Error un-liking the element, please try again"),{element:"#container",duration:3e3}):(e.removeClass("active"),n.decrementStat(a))})},elementCommentMore:function(e){e.preventDefault();var t=this,n=$(e.target),r=n.parents(".s-element"),i=r.find(".more"),a=r.find(".previous ul"),o=r.find(".element-comment-n"),u=r.attr("data-eid"),l=3;r.data("n")||r.data("n",1*o.text());var c=r.data("page")||2,d=r.data("n");i.addClass("loading");var f="/elements/"+u+"/comments",h={per_page:l,page:c,username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid};s.api.request("GET",f,h,{},function(e,n){if(e)i.remove();else{var u=n.content.comments;u.forEach(function(e){a.append(s.templates.render("story/elements/_comment",{comment:e}))}),d-=l,r.data("page",++c),0>=d?i.remove():(r.data("n",d),o.text(d),i.removeClass("loading")),t.updateTimestamps(a)}})},elementCommentRemove:function(e){e.preventDefault();var n=this,r=$(e.currentTarget),i=r.parents(".s-element"),a=r.parents(".comment"),o=i.find(".stats-comments"),u=a.attr("data-id"),l=i.attr("data-eid");if(confirm("Are you sure?")){var c="/elements/"+l+"/comments/remove",d={username:s.auth.user.username,_token:s.auth.user._token,comment:u,sid:s.story.sid};s.api.request("POST",c,d,{},function(e){e?s.notify.error(t("Error removing a comment from the element, please try again"),{element:"#container",duration:3e3}):(a.remove(),n.decrementStat(o))})}},elementCommentSubmit:function(e){if(13==e.keyCode){e.preventDefault();var t=this,n=$(e.currentTarget),r=n.val();n.parents(".s-element"),$.fn.tipsy&&n.parents(".action-container").find(".element-comment-post, .story-comment-post").tipsy("hide"),r&&(s.auth.user?t.elementComment(n,r):s.auth.loginPopup(function(e,i){!e&&i&&(t.postMessage({method:"login",value:i}),t.elementComment(n,r))}))}},elementComment:function(e,t){var n=this,r=e.parents(".s-element"),i=r.find(".stats-comments"),a=r.find(".element-comment-facebook").hasClass("active"),o=r.find(".element-comment-twitter").hasClass("active"),u=r.attr("data-eid");e.prop("disabled",!0);var l="/elements/"+u+"/comments/add",c={username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid,comment:_.trim(t),twitter:o,facebook:a};s.api.request("POST",l,c,{},function(t,a){if(t)e.val("").prop("disabled",!1);else{var o=a.content,u=$(s.templates.render("story/elements/_comment",{comment:o,prune:!1}));r.find(".previous ul").prepend(u),n.updateTimestamps(),e.val("").blur(),e.prop("disabled",!1),n.incrementStat(i);var l=$("body").attr("data-query")||"no-query";analytics.track("engagement",{event:"element-comment",searchQuery:l,context:"embed-local",auth:!0,source:r.attr("data-source")})}})},incrementStat:function(e,t){var t=1*e.html()+(t||1);e.html(t)},decrementStat:function(e,t){var t=t||1;this.incrementStat(e,-t)},incrementStatModal:function(e){var t=parseInt(e.text())+1;e.find("span").text(t),e.show(),e.parents(".shared-element-actions").find("a.like").removeClass("no-like")},decrementStatModal:function(e){var t=parseInt(e.text())-1;e.find("span").text(t),0===t&&(e.hide(),e.parents(".shared-element-actions").find("a.like").addClass("no-like"))},elementCommentButtonClicked:function(e){e.preventDefault();var t=this,n=$(e.currentTarget),r=n.parents(".s-element"),i=r.find(".comments"),s=r.find(".buttons .comment");s.toggleClass("pressed"),i.slideToggle(200,function(){t.resize(),i.is(":visible")&&i.find(".element-comment-input").focus()})},elementShareButtonClicked:function(e){var t=$(e.target);t.parents(".s-element"),e.stopPropagation(),e.preventDefault();var t=$(e.target).hasClass("share")?$(e.target):$(e.target).parent();t.toggleClass("active");var n=t.parents(".s-element").find(".s-share-dropdown");n.toggle()},elementShareDropdownHide:function(e){return},subscribeButtonClicked:function(e){e.preventDefault();var t=this;analytics.track("engagement",{event:"story-subscribe",context:"embed-local",story:s.story.permalink,author:s.user.username,authenticated:!!s.auth.user}),s.auth.user?t.subscribe():s.auth.loginPopup(function(e,n){!e&&n&&(t.postMessage({method:"login",value:n}),t.subscribe())})},subscribe:function(){var e=this;s.auth.follow(s.user.username,function(t){t||(e.el.subscribeButton.hide(),e.el.subscribeLabel.hide(),e.el.subscribedLabel.removeClass("hidden"))})},likeButtonLiked:function(e){if(this.likeButton.enable(),this.embedLikeButton.enable(),this.el.embedLikeButton.addClass("active"),this.el.likeButton.addClass("active"),e!==!0){var t=this.el.likeButton.find(".like-count"),n=parseInt(t.html())+1;t.html(n),t.removeClass("hidden"),t=this.el.embedLikeButton.find(".like-count"),t.html(n),t.removeClass("hidden"),s.story.liked=!0;var r=$("body").attr("data-query")||"no-query";analytics.track("engagement",{event:"story-like",searchQuery:r,context:"embed",auth:!0,source:"story"})}},likeButtonUnliked:function(e){if(this.likeButton.enable(),this.embedLikeButton.enable(),this.el.likeButton.removeClass("active"),this.el.embedLikeButton.removeClass("active"),e!==!0){var t=this.el.likeButton.find(".like-count"),n=parseInt(t.html())-1;t.html(n),0==n&&(this.el.likeButton.addClass("no-like"),t.addClass("hidden")),t=this.el.embedLikeButton.find(".like-count"),t.html(n),0==n&&(this.el.embedLikeButton.addClass("no-like"),t.addClass("hidden")),s.story.liked=!1}},likeError:function(e){var t,n=this;this.likeButton.enable(),this.embedLikeButton.enable();try{t=JSON.parse(e.responseText),t.error.message.match("duplicate_like")?(n.likeButtonLiked(!0),n.embedLikeButton(!0)):t.error.message.match("not_liked")&&(n.likeButtonUnliked(!0),n.embedLikeButton(!0))}catch(r){}},like:function(){var e=this;e.likeButton&&e.likeButton.disable(),e.embedLikeButton&&e.embedLikeButton.disable(),e.isEmbed||e.animateBigLike();var t="/stories/"+s.user.username+"/"+s.story.slug+"/like",n={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",t,n,{},function(t,n){t?e.likeError(t):e.likeButtonLiked(n)})},unlike:function(){var e=this;e.likeButton&&e.likeButton.disable(),e.embedLikeButton&&e.embedLikeButton.disable();var t="/stories/"+s.user.username+"/"+s.story.slug+"/unlike",n={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",t,n,{},function(t,n){t?e.likeError(t):e.likeButtonUnliked(n)})},deactivateLike:function(){var e=this;s.auth.user?(e.unlike(),e.shareDropdown&&e.shareDropdown.deactivate()):s.auth.loginPopup(function(t,n){!t&&n&&(e.postMessage({method:"login",value:n}),e.unlike)})},activateLike:function(e){var t=this,n=$(e.target);n.parents(".s-element");var r=$("body").attr("data-query")||"no-query";analytics.track("engagement",{event:"story-like",searchQuery:r,auth:!!s.auth.user,source:"story"}),s.auth.user?(t.like(),t.shareDropdown&&t.shareDropdown.activate()):s.auth.loginPopup(function(n,r){!n&&r&&(t.postMessage({method:"login",value:r}),t.like(e))})},animateBigLike:function(){var e=460,t=412,n=this;n.el.bigLike.show().animate({opacity:.8,width:e,height:t,marginLeft:e/-2,marginTop:t/-2},250,function(){setTimeout(function(){n.el.bigLike.animate({opacity:0,width:2*e,height:2*t,marginLeft:-e,marginTop:-t},250,function(){n.el.bigLike.hide().css({opacity:.8,width:e/2,height:t/2,marginLeft:e/-4,marginTop:t/-4})})},500)})},elementClick:function(e){var t=$(e.currentTarget),n=$("body").attr("data-query")||"no-query";analytics.track("browse",{event:"element-view",searchQuery:n,context:"embed-local",href:t.attr("href")})},embedCodeCopied:function(){var e=this;e.el.embedCopy.text("✓ copied").fadeOut("slow",function(){e.el.embedCopy.text("copy").fadeIn("fast")})},embedCodeClick:function(e){e.preventDefault(),$(this).select()},changeEmbedCode:function(){var e=this,t=[];this.el.embedOptions.length>0&&("slideshow"==this.el.embedTemplate.val()?(t.push("template=slideshow"),this.el.embedShowOptions.fadeOut("fast")):(this.el.embedShowOptions.fadeIn("fast"),this.el.embedHeader.attr("checked")||t.push("header=false"),this.el.embedBorder.attr("checked")||t.push("border=false"))),this.el.embedSEO.attr("checked")&&!this.seo?$.get(s.base_url+"/"+this.path+"/text",function(n){e.seo=n,e.setEmbedCode(t)}):this.setEmbedCode(t)},setEmbedCode:function(e){e=e.join("&");var t={base:s.base_url,username:s.user.username,slug:s.story.slug,title:s.story.title,options:e?"?"+e:"",seo:this.el.embedSEO.attr("checked")?this.seo||"":""},n=s.utils.template(this.embedCodeTemplate,t);this.el.embedSEO.attr("checked")&&this.seo&&(n+=this.seo),n+="</noscript></div>",this.el.embedCode.val(n)},sendEmail:function(){var e=this,n={to:this.el.emailTo.val(),from:this.el.emailFrom.val()};if(!n.from)return this.el.emailFrom.addClass("error").focus(),void 0;if(!n.to)return this.el.emailTo.addClass("error").focus(),void 0;this.el.emailSend.attr("disabled",!0).find("span").text(t("Sending"));var r="/stories/"+s.user.username+"/"+s.story.slug+"/email",i=n;s.api.request("POST",r,i,{},function(n){n?(e.el.emailSend.removeAttr("disabled").find("span").text(t("Send")),e.el.emailResultError.show(),setTimeout(function(){e.el.emailResultError.fadeOut(500)},3e3)):(e.el.emailSend.removeAttr("disabled").find("span").text(t("Send")),e.el.emailTo.val(""),e.el.emailResultSuccess.show(),setTimeout(function(){e.el.emailResultSuccess.fadeOut(500)},3e3))})},onMessage:function(e){var t=e.originalEvent.data;switch(t){case"loadMore":this.has_feature("infinite_scroll",this.loadMore);break;case"enableAutoReload":this.autoReload=!0;break;case"disableAutoReload":this.autoReload=!1;break;default:/^hashchange:/.test(t)&&this.linkClick("#"+t.slice(11))}},loadMore:function(e){var n=this,r=s.store.get("user");"function"!=typeof e&&(e=function(){}),n.el.loadMore.attr("disabled",!0),s.api.request("GET","/stories/"+n.path,{per_page:n.per_page,page:n.page++,published:"true"!==n.el.loadMore.attr("data-preview"),username:r&&r.username?r.username:void 0,_token:r&&r._token?r._token:void 0},{retryLimit:3},function(r,i){function a(){--d<=0&&e(null,f)}if(r)s.notify.error(t("Error loading more, please try again"),{element:"#container",duration:3e3}),n.el.loadMore.attr("disabled",!1),e&&e(r);else{s.story=i.content;var o=i.content.elements,u=n.page>20?!1:!0,l=!!$("#embed-footer").length,c={story:s.story,sid:s.story.sid,elements:o,embedTweets:u,isEmbed:l};o=$(s.templates.render("story/_elementsList",c)),n.el.elementsList.append(o);var d=1,f=!1;"undefined"!=typeof twttr&&twttr&&twttr.widgets&&(setTimeout(twttr.widgets.load,1),d++,twttr.events.bind("loaded",a)),"undefined"!=typeof FB&&FB&&FB.init&&setTimeout(function(){d++,FB.XFBML.parse(document.body,a)},1),"object"==typeof sidenotes&&sidenotes.updateAnchors(".s-element:not(.s-element-text) > div, .s-text > p, .s-text:not(:has(p, h2))"),o.length<n.per_page?(n.el.loadMore.remove(),n.postMessage({method:"noMoreElements"}),f=!1,a()):(n.el.loadMore.removeAttr("disabled"),f=!0,a()),_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");t.text(s.utils.date(n).fromNow())}),n.render(),s.page&&s.page.reinitialize()}})},reload:function(e){var t=this,n=s.store.get("user"),r="/stories/"+t.path,i={per_page:t.per_page,username:n&&n.username?n.username:void 0,_token:n&&n._token?n._token:void 0,timestamp:s.story.date.published};s.api.request("GET",r,i,{},function(n,r){if(n)e(n);else{if(r.content.version===s.story.version)return e();s.story=r.content;var i=r.content.elements;s.story.date.published=r.content.date.published,i=s.templates.render("story/_elementsList",{sid:s.story.sid,elements:i,embedTweets:!0}),t.page=2,t.el.elementsList.html(i),$(".s-published-date").attr("data-timestamp",s.story.date.published),"undefined"!=typeof twttr&&twttr&&setTimeout(twttr.widgets.load,1),"undefined"!=typeof FB&&FB&&FB.init&&setTimeout(function(){FB.init({status:!0,cookie:!0,xfbml:!0})},1),i.length<t.per_page&&(t.el.loadMore.remove(),t.postMessage({method:"noMoreElements"})),_.each($(".timestamp"),function(e){var t=$(e),n=t.attr("data-timestamp");t.text(s.utils.date(n).fromNow())}),t.render(),e()}})},ensureResize:function(e,t){var n=this,e=e||20,t=t||200,r=setInterval(function(){n.resize(),e--||clearInterval(r)},t)},resize:function(e){if(!e){if(!$("body")||!$("body").height())return;e=$("body").height()}300>=e||(this.height=e,this.postMessage({method:"resize",value:this.height}))},postMessage:function(e){return s.story?(e.sourceName=s.story.author.username+"-"+s.story.slug,window.parent.postMessage(JSON.stringify(e),"*"),void 0):(s.raven&&s.raven.started&&s.raven.Raven.captureMessage("embed.local.js:1448. Why no story? : "+JSON.stringify(s)),void 0)},bottomLinkClicked:function(){return!0},bottomLikeClicked:function(){var e=this,t=$("body").attr("data-query")||"no-query";return analytics.track("engagement",{event:"story-like",searchQuery:t,context:"embed-local"}),s.story.liked?alert("Thank you but you already liked this story!"):(this.like(),this.el.bottomLiked.fadeIn(250,function(){setTimeout(function(){e.el.bottomLiked.fadeOut(250)},3e3)})),!1},shareButtonClicked:function(e){e.preventDefault();var t=$(e.target),n=t.parents(".s-element"),r=t.attr("rel"),i=t.data("media"),a=t.parents(".s-actions-share").data("url"),o='From "'+s.story.title+'" story by '+s.story.author.name+" on Storify — "+s.story.permalink,u=t.data("video"),l=s.story.title,c=n.attr("data-type"),d=function(e){return e&&0!=e.length?"“"+e.replace(/<a[^>]+>([^<]+)<\/a>/g,function(e,t){return e.match(/twitter\.com/)?t:""}).replace(/RT @([^ ]){1,15}:?/g,"").replace(/( ){2,}/g," ").replace(/^ | $/g,"")+"”":""};switch(c){case"quote":l=d(n.find(".s-quote-text").html());break;case"image":l=d(n.find(".s-image-caption").html())}switch(r){case"storify":this.elementStorypadAdd(c,n.data("permalink"));break;case"email":analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:"email",type:n.attr("data-type")}),window.location.href="mailto:?subject="+s.story.title+"&body="+a;break;case"pinterest":analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:"pinterest",type:n.attr("data-type")}),this.pin(i,a,o,u);break;case"facebook":analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:"facebook",type:n.attr("data-type")}),this.share(r,a,s.story.title);break;default:analytics.track("engagement-share",{event:"element-shared",context:"embed-local",via:r,type:n.attr("data-type")}),this.share(r,a,s.story.title)}},share:function(e,t,n){var r;switch(e){case"facebook":r="http://www.facebook.com/sharer.php?u="+encodeURIComponent(t);break;case"twitter":r="http://twitter.com/intent/tweet?text="+encodeURIComponent(n)+"&url="+encodeURIComponent(t);var i=$('meta[property="twitter:creator"]').attr("content")||"Storify";n.length<105&&(r+="&via="+i);break;case"googleplus":r="http://plus.google.com/share?url="+encodeURIComponent(t);break;case"linkedin":r="http://www.linkedin.com/shareArticle?url="+encodeURIComponent(t)}window.open(r,"sharer","toolbar=0,status=0,resizable=1,width=626,height=436")},shareFacebookImg:function(e){var t=e.find(".s-share-facebook");t.addClass("s-share-facebook-loading");var n="/elements/"+e.attr("data-eid")+"/share",r={username:s.auth.user.username,_token:s.auth.user._token,sid:s.story.sid};s.api.request("POST",n,r,{},function(e){e||(t.removeClass("s-share-facebook-loading"),t.addClass("s-share-facebook-done"),setTimeout(function(){t.fadeOut(500,function(){t.removeClass("s-share-facebook-done"),t.show()})},2e3))})},pin:function(e,t,n,r){window.open("http://pinterest.com/pin/create/bookmarklet/?media="+encodeURIComponent(e)+"&url="+encodeURIComponent(t)+"&description="+encodeURIComponent(n)+"&is_video="+encodeURIComponent(r),"sharer","toolbar=0,status=0,resizable=1,width=632,height=270")},showFocus:function(e){$input=$(e.target),$input.parents(".action").addClass("focus")},hideFocus:function(e){$input=$(e.target),$input.parents(".action").removeClass("focus"),$.fn.tipsy&&$input.parents(".action-container").find(".element-comment-post, .story-comment-post").tipsy("hide")},updateTimestamps:function(e){var e=e?e.find(".moment.fromNow"):$(".moment.fromNow");e.each(function(){var e=$(this);e.html(moment(e.attr("data-date")).fromNow())})},embedLikeButtonClicked:function(e){e.preventDefault(),$target=$(e.currentTarget),$target.hasClass("active")?this.embedUnlike($target):this.embedLike($target)
},embedLike:function(e){var t=this,n="/stories/"+s.user.username+"/"+s.story.slug+"/like",r={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",n,r,{},function(n){n||(e.addClass("active"),t.incrementStat($target.find(".like-count")))})},embedUnlike:function(e){var t=this,n=e.parents(".s-element").attr("data-eid"),r=$(".s-element[data-eid="+n+"]");r.find(".stats-likes");var i="/stories/"+s.user.username+"/"+s.story.slug+"/unlike",a={username:s.auth.user.username,_token:s.auth.user._token};s.api.request("POST",i,a,{},function(n){n||(e.removeClass("active"),t.decrementStat($target.find(".like-count")))})},getRelatedStories:function(){var e=this,t="development"==s.env?s.api_url+"/stories/":"//api.storify.com/v1/stories/";$.ajax(t+s.story.author.username+"/"+s.story.slug+"/related",{type:"get",dataType:"jsonp",cache:!0,jsonpCallback:"sfyRelatedStoriesFor"+s.story.slug.replace(/\-/g,""),data:{per_page:3},success:function(t){200==t.code&&0!=t.content.stories.length&&(s.story.relatedStories=t.content.stories,e.renderRelatedStories(s.story.relatedStories),$(window).trigger("storify.relatedStories.load",s.story.relatedStories))}})},renderRelatedStories:function(e){e&&0!==e.length&&(this.isEmbed?this.renderRelatedStoriesEmbed(e):this.renderRelatedStoriesOnStorify(e))},renderRelatedStoriesEmbed:function(e){switch(e.length){case 1:$("#story #related-stories h3").text(t("related_story"));break;case 3:var n=Math.floor(Math.random()*e.length);e=e.slice(),e.splice(n,1)}var r=(Math.min(window.innerWidth||630,630)-125)/6-18,i=self.isEmbed?"embed":"storypage";for(var a in e){var o=e[a];o.author?o.author.name=o.author.name||o.author.username:o.author={name:""};var u=$('<a href="'+o.permalink+"?utm_source=story&utm_media="+i+'&utm_content=related" target="_blank" class="related-story-title">'+s.utils.smart_truncate(o.title,Math.max(r,45))+"</a> "),l=$('<a href="https://storify.com/'+o.author.username+'" target="_blank" class="related-story-author">('+o.author.name+")</a>");o.description=o.description||"";var c=o.thumbnail&&!o.thumbnail.match(/public\/img\/default\-thumb/)?'<img src="'+s.utils.proxy_image(o.thumbnail,50)+'" class="related" />':"",d="<b>"+o.title+"</b><p>"+c+o.description+"</p>";analytics.trackLink(u,"click_related_story_from_embed"),$.fn.tipsy&&u.tipsy({opacity:.95,fade:!0,html:!0,trigger:"hover",gravity:"sw",fallback:d,offset:2});var f=$("<li>").append(u).append(l);$("#story #related-stories ul.stories").append(f)}$("#story #related-stories").show()},renderRelatedStoriesOnStorify:function(e){$("#related-stories").show();for(var t=$("#related-stories ul"),n=t.find("li.template"),r=0;r<e.length;r++){var i=e[r];i.thumbnail.match(/\/public\/img\/default-thumb\.gif$/)&&(i.thumbnail="/public/img/related-placeholder@2x.png");var s=n.clone();s.find(".thumbnail").css("background-image",'url("'+i.thumbnail+'")'),s.find("a.permalink").attr("href",i.permalink),s.find(".title").text(i.title),s.removeClass("hidden"),t.append(s)}},linkClick:function(e){function t(e){return e.origin||e.protocol+"//"+e.hostname+(e.port?":"+e.port:"")}function n(e){return e.pathname.replace(/^\//,"")}function r(e,t){var n=$(s);n.length>0?u?(i.postMessage({method:"scroll",value:n.offset().top}),i.postMessage({method:"setHash",value:s})):$("html, body").animate({scrollTop:n.offset().top},"fast",function(){window.location.hash=s}):t&&(u?i.postMessage({method:"scroll",value:i.el.loadMore.offset().top}):$("html, body").animate({scrollTop:i.el.loadMore.offset().top},"fast"),i.loadMore(r))}var i=this;if("string"==typeof e)var s=e;else if(e&&e.preventDefault){var a=e.currentTarget,o=window.location;if(t(a)===t(o)&&n(a)===n(o)){e.preventDefault();var s=a.hash}}if(s){var u=!0;try{u=window.self!==window.top}catch(e){}r(null,!0)}}}),$(function(){new s.Embed});

//@ sourceMappingURL=3.2.81-production-fb2b39a5-7a61f912116f5d685f606ee184cc44ec.js.map